# guestinfo-network

Tool to configure networking on Amazon Linux 2 using VMware guestinfo.

## Usage

Disable cloud-config networking

```
# /etc/cloud/cloud.cfg.d/80_disable_network_after_firstboot.cfg
# Disable network configuration after first boot
network:
  config: disabled
```

Create a systemd unit to execute `guestinfo-network` and replace the default `eth0` configuration.
 
```
# /etc/systemd/system/guestinfo-network.service
[Unit]
Description="Setup networking from guestinfo data"
Before=network-pre.target
Wants=network-pre.target
[Service]
Type=oneshot
ExecStart=/bin/sh -c '/usr/sbin/guestinfo-network > /etc/sysconfig/network-scripts/ifcfg-eth0'
[Install]
WantedBy=multi-user.target
```

Terraform example using VMware vSphere guestinfo.

Example metadata JSON. We gzip+base64 encode the JSON before passing it to `guestinfo.metadata`.

```json
{
  "hostname": "myhost",
  "gateway": "10.10.10.1",
  "ipaddr": "10.10.10.100",
  "netmask": "255.255.255.0",
  "bootproto": "none"
}
```
If bootproto is anything other than `none` we fallback to using DHCP.

```hcl
resource "vsphere_virtual_machine" "server" {
  ...
  ...

  extra_config = {
    "guestinfo.metadata.encoding" = "gzip+base64"
    "guestinfo.metadata"          = base64gzip(var.metadata)
  }
}
```

Example static address:

```
# Generated by guestinfo-network
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=none
ONBOOT=yes
IPADDR=10.10.10.1
GATEWAY=10.10.10.1
NETMASK=255.255.255.0
NM_CONTROLLED=no
```

Example DHCP address:
```
# Generated by guestinfo-network
DEVICE=eth0
TYPE=Ethernet
BOOTPROTO=dhcp
ONBOOT=yes
NM_CONTROLLED=no
```
